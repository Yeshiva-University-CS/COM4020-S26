# requirements.md

## Trading Model and Rules

This document defines the trading-related rules and invariants of the system. These rules describe what must be true about system behavior, not how the system must be implemented.

---

## Symbols

- The system operates on a fixed, predefined set of symbols (for example: AAPL, MSFT, GOOG).
- Each symbol is quoted independently.
- All symbols contribute to a shared global exposure limit.

---

## External Order Publisher

- External orders are generated by an external order publisher.
- The external order publisher connects to the exchange through a defined API.
- The external order publisher has no access to internal trading state.
- The external order publisher may submit buy or sell orders for any symbol at any time.
- The external order publisher may submit multiple orders concurrently.

The external order publisher exists solely to drive trading activity and exercise system behavior under load, concurrency, and failure.

---

## Exchange

- The exchange accepts external orders through its API.
- The exchange matches external orders against active quotes.
- The exchange generates fills when external orders execute against quotes.
- The exchange does not track positions or exposure limits.
- The exchange does not decide whether quotes are allowed.

---

## Positions

- Each symbol has a single net position.
- Positions are updated sequentially by applying recorded fills.
- A positive position represents a long position.
- A negative position represents a short position.
- Positions are authoritative for reporting and display purposes.
- Positions are not used to compute global exposure usage.

Example:

- Initial position: 0  
- Buy fill of 3 → position = +3  
- Sell fill of 5 → position = –2  

---

## Quotes

- A quote consists of:
  - a bid price and quantity
  - an ask price and quantity
- At most one quote may be active for a given symbol at any time.
- A quote is eligible for execution only while it is active and unexpired.
- Each quote has a time-to-live (TTL) of 30 seconds.
- A quote may be partially filled by external orders.

Example:

AAPL quote:
- Bid: 99 × 10
- Ask: 101 × 10
- TTL: 30 seconds

---

## Fills

- A fill represents an executed trade against an active quote.
- Fills are generated by the exchange.
- A fill is immutable once created.
- Fills are recorded durably before any quote replacement occurs.

---

## Quote Updates

- Market makers do not react directly to raw fill events.
- Quotes are updated only in response to:
  - committed position updates, or
  - quote expiration.
- Quote updates must reflect the latest committed position state.
- Quote updates derived from older position state must not override newer quote state.

---

## Global Exposure Limit

- The system enforces a symmetric net exposure limit of ±100.
- Global exposure usage is computed exclusively from the quantities of currently active quotes.
- Current positions are not included when calculating global exposure usage.

The exposure limit constrains the worst-case resulting position implied by active quotes.

---

## Exposure Enforcement During Quoting

Before a quote becomes active, the system must ensure that:

If the quote were to fully fill, the resulting position would remain within the allowed range of –100 to +100.

This rule applies independently to the bid and ask sides of a quote.

---

### Buy Quotes (Bids)

- A buy quote increases the position.
- A buy quote is allowed only if:

  current_position + quote_quantity ≤ +100

Example:

- Current position: –75
- Intended buy size: 50
- Resulting position: –25 → allowed

---

### Sell Quotes (Asks)

- A sell quote decreases the position.
- A sell quote is allowed only if:

  current_position – quote_quantity ≥ –100

Example:

- Current position: –75
- Intended sell size: 50
- Resulting position: –125 → not allowed
- Maximum allowed sell size: 25

---

## Partial Capacity Handling

If insufficient exposure capacity exists for the intended quote size:

- The quote quantity is reduced deterministically to the maximum allowed size.
- If no capacity exists:
  - the quote is not published, or
  - an existing quote is allowed to expire without replacement.

Example:

- Current position: –75
- Intended sell size: 50
- Remaining allowable sell size: 25
- Published sell size: 25

---

## Exposure Lifecycle

Exposure capacity associated with a quote must be adjusted or released when:

- the quote is partially filled
- the quote is fully filled
- the quote is replaced
- the quote expires

Example:

- Active sell quote: 40
- Exposure reserved: 40
- Fill occurs: sell 10
- Remaining reserved exposure: 30

---

## Quote Expiration

- A quote expires automatically after 30 seconds if not refreshed.
- An expired quote cannot be filled.
- Exposure capacity associated with an expired quote must be released.

Example:

- Bid: 99 × 10
- TTL expires with no fills
- Bid is removed
- 10 units of exposure capacity are released

---

## Price Behavior

- Quotes advertise liquidity but do not directly move prices.
- Prices change only as a result of executed fills.
- The absence of a bid or ask does not change the reference price by itself.

---

## Correctness Invariants

- At no time may a quote be active if it would allow a position outside the range –100 to +100.
- At no time may the total exposure implied by active quotes exceed the global exposure limit.
- Exposure capacity must not remain reserved for expired or replaced quotes.
- The system must converge to a correct position and quote state after crashes, retries, or delayed processing, without manual intervention.
